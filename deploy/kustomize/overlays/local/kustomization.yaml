apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Local overlay: targets a k3d cluster with images loaded via `k3d image import`.
#
# Tag convention: images are pinned to `dev` here, which matches the Makefile
# default (VERSION=dev). The full local workflow is therefore simply:
#
#   make k3d-up          # first time
#   make k3d-redeploy    # after every code change
#
# For release or staging builds, override VERSION at the make invocation:
#
#   make k3d-load VERSION=v1.2.3
#
# and update newTag below to match before applying.

namespace: iiot

resources:
  - ../../base

images:
  - name: iiot-collector
    newTag: dev
  - name: iiot-ingestor
    newTag: dev
  - name: iiot-mqtt-bridge
    newTag: dev

patches:
  # Patch ingestor Service to NodePort so the API is reachable from the host
  # via the k3d load-balancer without a separate port-forward.
  - path: ingestor-nodeport-patch.yaml
    target:
      kind: Service
      name: ingestor
  # Force replicas=1 locally. The ingestor PVC is ReadWriteOnce; SQLite does not
  # support concurrent writers. Two replicas serve no purpose on a single-node
  # k3d cluster and would cause SQLITE_BUSY errors or Pending pods on multi-node.
  - path: ingestor-replicas-patch.yaml
    target:
      kind: Deployment
      name: ingestor
